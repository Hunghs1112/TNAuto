# üîÑ Y√äU C·∫¶U C·∫¨P NH·∫¨T BACKEND - UNIFIED LOGIN FLOW

**Version**: 1.1.0  
**Ng√†y t·∫°o**: October 21, 2025  
**M·ª©c ƒë·ªô ∆∞u ti√™n**: HIGH  
**·∫¢nh h∆∞·ªüng**: Authentication Flow

---

## üìã T·ªîNG QUAN

### V·∫•n ƒë·ªÅ hi·ªán t·∫°i
- Giao di·ªán login c√≥ 2 mode ri√™ng bi·ªát (kh√°ch h√†ng / nh√¢n vi√™n)
- User ph·∫£i bi·∫øt tr∆∞·ªõc m√¨nh l√† lo·∫°i t√†i kho·∫£n n√†o
- UX kh√¥ng t·ªëi ∆∞u, g√¢y r·ªëi cho ng∆∞·ªùi d√πng

### Gi·∫£i ph√°p m·ªõi
- **Unified Login**: User ch·ªâ c·∫ßn nh·∫≠p s·ªë ƒëi·ªán tho·∫°i
- H·ªá th·ªëng t·ª± ƒë·ªông ph√°t hi·ªán lo·∫°i t√†i kho·∫£n:
  - **Kh√°ch h√†ng** ‚Üí ƒêƒÉng nh·∫≠p tr·ª±c ti·∫øp (kh√¥ng c·∫ßn m·∫≠t kh·∫©u)
  - **Nh√¢n vi√™n** ‚Üí Y√™u c·∫ßu nh·∫≠p m·∫≠t kh·∫©u ·ªü m√†n h√¨nh ti·∫øp theo
  - **Ch∆∞a ƒëƒÉng k√Ω** ‚Üí ƒê·ªÅ xu·∫•t ƒëƒÉng k√Ω

---

## üÜï API M·ªöI C·∫¶N T·∫†O

### üìç **Endpoint**: `POST /api/auth/check-phone`

**M·ª•c ƒë√≠ch**: Ki·ªÉm tra s·ªë ƒëi·ªán tho·∫°i v√† x√°c ƒë·ªãnh lo·∫°i user

**Route location**: `routes/authRoutes.js` (t·∫°o m·ªõi n·∫øu ch∆∞a c√≥)

---

## üì• REQUEST FORMAT

### Headers
```http
Content-Type: application/json
```

### Body
```json
{
  "phone": "0901234567"
}
```

### Validation Rules
- `phone` l√† **b·∫Øt bu·ªôc** (required)
- `phone` ph·∫£i l√† string
- N√™n validate format s·ªë ƒëi·ªán tho·∫°i Vi·ªát Nam (optional nh∆∞ng recommended)

---

## üì§ RESPONSE FORMAT

### ‚úÖ **Case 1: T√¨m th·∫•y kh√°ch h√†ng**

**HTTP Status**: `200 OK`

```json
{
  "success": true,
  "user_type": "customer",
  "message": "Customer account found",
  "data": {
    "id": 123,
    "name": "Nguy·ªÖn VƒÉn A",
    "phone": "0901234567",
    "email": "nguyenvana@email.com",
    "license_plate": "30A-12345",
    "avatar_url": "https://example.com/avatar.jpg"
  }
}
```

---

### üë∑ **Case 2: T√¨m th·∫•y nh√¢n vi√™n**

**HTTP Status**: `200 OK`

```json
{
  "success": true,
  "user_type": "employee",
  "message": "Employee account found",
  "data": {
    "id": 45,
    "name": "Tr·∫ßn Th·ªã B",
    "phone": "0912345678",
    "position": "K·ªπ thu·∫≠t vi√™n",
    "avatar_url": "https://example.com/avatar-employee.jpg"
  }
}
```

**‚ö†Ô∏è L∆ØU √ù**: 
- **KH√îNG tr·∫£ v·ªÅ password** trong response
- **KH√îNG tr·∫£ v·ªÅ c√°c th√¥ng tin nh·∫°y c·∫£m** (employee_id n·ªôi b·ªô, v.v.)

---

### ‚ùå **Case 3: Kh√¥ng t√¨m th·∫•y**

**HTTP Status**: `200 OK`

```json
{
  "success": true,
  "user_type": "not_found",
  "message": "Phone number not registered"
}
```

**Note**: V·∫´n tr·∫£ `200 OK` v√¨ ƒë√¢y kh√¥ng ph·∫£i l·ªói server, ch·ªâ l√† kh√¥ng t√¨m th·∫•y user.

---

### üö´ **Case 4: L·ªói validation**

**HTTP Status**: `400 Bad Request`

```json
{
  "success": false,
  "error": "Phone number is required"
}
```

Ho·∫∑c:

```json
{
  "success": false,
  "error": "Invalid phone number format"
}
```

---

### ‚ö†Ô∏è **Case 5: L·ªói server**

**HTTP Status**: `500 Internal Server Error`

```json
{
  "success": false,
  "error": "Database connection error",
  "details": "Error details for debugging (ch·ªâ trong dev mode)"
}
```

---

## üíª IMPLEMENTATION LOGIC

### Flowchart

```
START
  ‚Üì
Nh·∫≠n request v·ªõi phone
  ‚Üì
Validate phone (required, format)
  ‚Üì OK
Query database: SELECT * FROM customers WHERE phone = ?
  ‚Üì
C√≥ k·∫øt qu·∫£? ‚Üí YES ‚Üí Return user_type: "customer" + data
  ‚Üì NO
Query database: SELECT * FROM employees WHERE phone = ?
  ‚Üì
C√≥ k·∫øt qu·∫£? ‚Üí YES ‚Üí Return user_type: "employee" + data
  ‚Üì NO
Return user_type: "not_found"
```

---

## üìù SAMPLE CODE (Node.js + Express + MySQL)

### 1. T·∫°o route file: `routes/authRoutes.js`

```javascript
const express = require('express');
const router = express.Router();
const db = require('../config/database'); // Your database connection

/**
 * POST /api/auth/check-phone
 * Check if phone number exists and return user type
 */
router.post('/check-phone', async (req, res) => {
  const { phone } = req.body;
  
  // Validation
  if (!phone) {
    return res.status(400).json({ 
      success: false, 
      error: 'Phone number is required' 
    });
  }

  // Optional: Validate phone format (Vietnamese phone numbers)
  const phoneRegex = /^(0|\+84)(3|5|7|8|9)[0-9]{8}$/;
  if (!phoneRegex.test(phone.replace(/\s/g, ''))) {
    return res.status(400).json({ 
      success: false, 
      error: 'Invalid phone number format' 
    });
  }

  try {
    // Step 1: Check in customers table
    const [customers] = await db.query(
      'SELECT id, name, phone, email, license_plate, avatar_url FROM customers WHERE phone = ?',
      [phone]
    );
    
    if (customers.length > 0) {
      const customer = customers[0];
      return res.json({
        success: true,
        user_type: 'customer',
        message: 'Customer account found',
        data: {
          id: customer.id,
          name: customer.name,
          phone: customer.phone,
          email: customer.email || null,
          license_plate: customer.license_plate || null,
          avatar_url: customer.avatar_url || null
        }
      });
    }
    
    // Step 2: Check in employees table
    const [employees] = await db.query(
      'SELECT id, name, phone, position, avatar_url FROM employees WHERE phone = ?',
      [phone]
    );
    
    if (employees.length > 0) {
      const employee = employees[0];
      return res.json({
        success: true,
        user_type: 'employee',
        message: 'Employee account found',
        data: {
          id: employee.id,
          name: employee.name,
          phone: employee.phone,
          position: employee.position || null,
          avatar_url: employee.avatar_url || null
        }
      });
    }
    
    // Step 3: Not found
    return res.json({
      success: true,
      user_type: 'not_found',
      message: 'Phone number not registered'
    });
    
  } catch (error) {
    console.error('Check phone error:', error);
    return res.status(500).json({ 
      success: false, 
      error: 'Server error',
      details: process.env.NODE_ENV === 'development' ? error.message : undefined
    });
  }
});

module.exports = router;
```

---

### 2. ƒêƒÉng k√Ω route trong `app.js` ho·∫∑c `server.js`

```javascript
const authRoutes = require('./routes/authRoutes');

// ... existing code ...

app.use('/api/auth', authRoutes);
```

---

## üß™ TEST CASES

### Test Case 1: Valid Customer Phone
**Request**:
```bash
curl -X POST http://localhost:3000/api/auth/check-phone \
  -H "Content-Type: application/json" \
  -d '{"phone": "0901234567"}'
```

**Expected Response**: `200 OK` v·ªõi `user_type: "customer"`

---

### Test Case 2: Valid Employee Phone
**Request**:
```bash
curl -X POST http://localhost:3000/api/auth/check-phone \
  -H "Content-Type: application/json" \
  -d '{"phone": "0912345678"}'
```

**Expected Response**: `200 OK` v·ªõi `user_type: "employee"`

---

### Test Case 3: Unregistered Phone
**Request**:
```bash
curl -X POST http://localhost:3000/api/auth/check-phone \
  -H "Content-Type: application/json" \
  -d '{"phone": "0999999999"}'
```

**Expected Response**: `200 OK` v·ªõi `user_type: "not_found"`

---

### Test Case 4: Missing Phone
**Request**:
```bash
curl -X POST http://localhost:3000/api/auth/check-phone \
  -H "Content-Type: application/json" \
  -d '{}'
```

**Expected Response**: `400 Bad Request` v·ªõi error message

---

### Test Case 5: Invalid Phone Format
**Request**:
```bash
curl -X POST http://localhost:3000/api/auth/check-phone \
  -H "Content-Type: application/json" \
  -d '{"phone": "123"}'
```

**Expected Response**: `400 Bad Request` v·ªõi error message

---

## üîí SECURITY CONSIDERATIONS

### ‚úÖ DO's
1. ‚úÖ **Lu√¥n validate input** (phone format, required fields)
2. ‚úÖ **Kh√¥ng tr·∫£ v·ªÅ password** trong response
3. ‚úÖ **Kh√¥ng tr·∫£ v·ªÅ th√¥ng tin nh·∫°y c·∫£m** (employee_id n·ªôi b·ªô, salary, v.v.)
4. ‚úÖ **Log errors** ƒë·ªÉ debug nh∆∞ng kh√¥ng expose trong production
5. ‚úÖ **Rate limiting**: √Åp d·ª•ng rate limit cho endpoint n√†y (tr√°nh brute force)

### ‚ùå DON'Ts
1. ‚ùå **Kh√¥ng tr·∫£ v·ªÅ chi ti·∫øt l·ªói database** trong production
2. ‚ùå **Kh√¥ng tr·∫£ v·ªÅ stack trace** cho client
3. ‚ùå **Kh√¥ng expose th√¥ng tin v·ªÅ c·∫•u tr√∫c database**

---

## üìä PERFORMANCE CONSIDERATIONS

### Database Optimization
1. **Index**: ƒê·∫£m b·∫£o c√≥ index tr√™n c·ªôt `phone` trong c·∫£ 2 b·∫£ng:
   ```sql
   CREATE INDEX idx_customers_phone ON customers(phone);
   CREATE INDEX idx_employees_phone ON employees(phone);
   ```

2. **Query Optimization**: S·ª≠ d·ª•ng `LIMIT 1` v√¨ ch·ªâ c·∫ßn 1 k·∫øt qu·∫£:
   ```sql
   SELECT ... FROM customers WHERE phone = ? LIMIT 1;
   ```

3. **Connection Pooling**: ƒê·∫£m b·∫£o s·ª≠ d·ª•ng connection pool cho database

---

## üîÑ MIGRATION PLAN

### Backward Compatibility
- ‚úÖ API c≈© v·∫´n ho·∫°t ƒë·ªông b√¨nh th∆∞·ªùng:
  - `POST /api/customers/login` (kh√¥ng thay ƒë·ªïi)
  - `POST /api/employees/login` (kh√¥ng thay ƒë·ªïi)
- ‚úÖ API m·ªõi l√† **b·ªï sung**, kh√¥ng thay th·∫ø

### Rollout Strategy
1. **Phase 1**: Deploy backend v·ªõi API m·ªõi
2. **Phase 2**: Test API m·ªõi tr√™n staging
3. **Phase 3**: Update mobile app v·ªõi flow m·ªõi
4. **Phase 4**: Monitor v√† thu th·∫≠p feedback
5. **Phase 5** (t∆∞∆°ng lai): C√≥ th·ªÉ deprecate API c≈© n·∫øu c·∫ßn

---

## üìö DOCUMENTATION UPDATE

### C·∫≠p nh·∫≠t file `API_DOCUMENTATION.md`

Th√™m section m·ªõi:

```markdown
### üîê AUTHENTICATION
**Base URL**: `/api/auth`

#### üì± Public Endpoints
| Method | Endpoint | M√¥ T·∫£ | Cache |
|--------|----------|-------|-------|
| `POST` | `/check-phone` | Ki·ªÉm tra s·ªë ƒëi·ªán tho·∫°i v√† x√°c ƒë·ªãnh lo·∫°i user | No cache |

**Request Body**:
```json
{
  "phone": "0901234567"
}
```

**Response**:
```json
{
  "success": true,
  "user_type": "customer" | "employee" | "not_found",
  "message": "...",
  "data": { ... }
}
```

**User Types**:
- `customer`: T√†i kho·∫£n kh√°ch h√†ng (t·ª± ƒë·ªông ƒëƒÉng nh·∫≠p, kh√¥ng c·∫ßn m·∫≠t kh·∫©u)
- `employee`: T√†i kho·∫£n nh√¢n vi√™n (y√™u c·∫ßu m·∫≠t kh·∫©u)
- `not_found`: S·ªë ƒëi·ªán tho·∫°i ch∆∞a ƒëƒÉng k√Ω
```

---

## üìû SUPPORT & QUESTIONS

### Implementation Questions?
- Check existing login endpoints: `/api/customers/login`, `/api/employees/login`
- Database schema: Xem file `tnauto.sql`
- Similar pattern: Endpoint n√†y t∆∞∆°ng t·ª± nh∆∞ login nh∆∞ng kh√¥ng authenticate

### Testing Support
- Postman collection s·∫Ω ƒë∆∞·ª£c cung c·∫•p sau khi implement
- Swagger docs s·∫Ω ƒë∆∞·ª£c c·∫≠p nh·∫≠t t·ª± ƒë·ªông n·∫øu c√≥ s·ª≠ d·ª•ng swagger-jsdoc

---

## ‚úÖ CHECKLIST

**Backend Developer**: Vui l√≤ng check c√°c items sau khi ho√†n th√†nh:

- [ ] T·∫°o file `routes/authRoutes.js`
- [ ] Implement logic check phone theo flowchart
- [ ] Validate input (phone required, format)
- [ ] Test v·ªõi phone c·ªßa customer ‚Üí tr·∫£ v·ªÅ ƒë√∫ng data
- [ ] Test v·ªõi phone c·ªßa employee ‚Üí tr·∫£ v·ªÅ ƒë√∫ng data
- [ ] Test v·ªõi phone kh√¥ng t·ªìn t·∫°i ‚Üí tr·∫£ v·ªÅ not_found
- [ ] Test v·ªõi input kh√¥ng h·ª£p l·ªá ‚Üí tr·∫£ v·ªÅ 400 error
- [ ] ƒê·∫£m b·∫£o kh√¥ng tr·∫£ v·ªÅ password
- [ ] Ki·ªÉm tra performance (c√≥ index tr√™n phone column)
- [ ] √Åp d·ª•ng rate limiting
- [ ] Update API documentation
- [ ] Deploy l√™n staging
- [ ] Th√¥ng b√°o frontend team ƒë·ªÉ test

---

## üìä EXPECTED TIMELINE

- **Implementation**: 2-4 hours
- **Testing**: 1-2 hours
- **Documentation**: 30 minutes
- **Total**: ~1 working day

---

**Prepared by**: Frontend Team - TNAUTO  
**Last Updated**: October 21, 2025  
**Status**: Pending Implementation

---

## üìß CONTACT

N·∫øu c√≥ th·∫Øc m·∫Øc, vui l√≤ng li√™n h·ªá:
- Frontend Lead: [contact info]
- Project Manager: [contact info]

