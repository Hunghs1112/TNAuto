# T√ÄI LI·ªÜU API - TNAUTO BACKEND

## üìã T·ªîNG QUAN

**TNAUTO Backend** l√† h·ªá th·ªëng API RESTful cho ·ª©ng d·ª•ng qu·∫£n l√Ω trung t√¢m b·∫£o d∆∞·ª°ng xe √¥ t√¥, h·ªó tr·ª£ c·∫£ ·ª©ng d·ª•ng di ƒë·ªông (kh√°ch h√†ng & nh√¢n vi√™n) v√† trang qu·∫£n tr·ªã web.

### Th√¥ng Tin Chung
- **Base URL**: `http://your-domain/api`
- **Framework**: Express.js (Node.js)
- **Database**: MySQL
- **Authentication**: Phone-based login
- **Push Notification**: Firebase Cloud Messaging (FCM)
- **File Upload**: Multer + Local Storage

### API Documentation
- **Swagger UI**: `http://your-domain/api-docs`
- **Health Check**: `http://your-domain/health`

---

## üèóÔ∏è C·∫§U TR√öC H·ªÜ TH·ªêNG

H·ªá th·ªëng g·ªìm 2 lo·∫°i API ch√≠nh:
- **üì± MOBILE API**: D√†nh cho ·ª©ng d·ª•ng di ƒë·ªông (kh√°ch h√†ng & nh√¢n vi√™n)
- **üë®‚Äçüíº ADMIN API**: D√†nh cho trang qu·∫£n tr·ªã web

---

## üìö DANH M·ª§C API THEO MODULE

H·ªá th·ªëng g·ªìm **14 modules API** ch√≠nh:

### 1Ô∏è‚É£ KH√ÅCH H√ÄNG (CUSTOMERS)
**Base URL**: `/api/customers`

#### üì± Mobile Endpoints
| Method | Endpoint | M√¥ T·∫£ |
|--------|----------|-------|
| `POST` | `/register` | ƒêƒÉng k√Ω kh√°ch h√†ng m·ªõi (c√≥ validation) |
| `POST` | `/login` | ƒêƒÉng nh·∫≠p b·∫±ng s·ªë ƒëi·ªán tho·∫°i |
| `PUT` | `/profile` | C·∫≠p nh·∫≠t th√¥ng tin c√° nh√¢n |
| `DELETE` | `/account` | X√≥a t√†i kho·∫£n |
| `GET` | `/services` | L·∫•y danh s√°ch d·ªãch v·ª• |
| `GET` | `/orders` | L·∫•y danh s√°ch ƒë∆°n h√†ng c·ªßa kh√°ch |
| `POST` | `/orders` | T·∫°o ƒë∆°n h√†ng m·ªõi |
| `GET` | `/orders/:id` | Xem chi ti·∫øt ƒë∆°n h√†ng |
| `GET` | `/vehicles` | L·∫•y danh s√°ch xe c·ªßa kh√°ch |

#### üë®‚Äçüíº Admin Endpoints
| Method | Endpoint | M√¥ T·∫£ |
|--------|----------|-------|
| `GET` | `/` | L·∫•y t·∫•t c·∫£ kh√°ch h√†ng (c√≥ ph√¢n trang & t√¨m ki·∫øm) |
| `GET` | `/stats` | Th·ªëng k√™ kh√°ch h√†ng |
| `GET` | `/:id` | Xem chi ti·∫øt kh√°ch h√†ng |
| `PUT` | `/:id` | C·∫≠p nh·∫≠t th√¥ng tin kh√°ch h√†ng |
| `PATCH` | `/:id` | C·∫≠p nh·∫≠t m·ªôt ph·∫ßn th√¥ng tin |
| `DELETE` | `/:id` | X√≥a kh√°ch h√†ng |
| `POST` | `/:id/upload-avatar` | Upload avatar kh√°ch h√†ng |

---

### 2Ô∏è‚É£ NH√ÇN VI√äN (EMPLOYEES)
**Base URL**: `/api/employees`

#### üì± Mobile Endpoints
| Method | Endpoint | M√¥ T·∫£ |
|--------|----------|-------|
| `POST` | `/login` | ƒêƒÉng nh·∫≠p nh√¢n vi√™n |
| `GET` | `/orders/assigned` | L·∫•y ƒë∆°n h√†ng ƒë∆∞·ª£c ph√¢n c√¥ng |
| `GET` | `/orders` | L·∫•y t·∫•t c·∫£ ƒë∆°n h√†ng c·ªßa nh√¢n vi√™n |
| `GET` | `/orders/:id` | Chi ti·∫øt ƒë∆°n h√†ng |

#### üë®‚Äçüíº Admin Endpoints
| Method | Endpoint | M√¥ T·∫£ |
|--------|----------|-------|
| `GET` | `/` | L·∫•y t·∫•t c·∫£ nh√¢n vi√™n (c√≥ ph√¢n trang & t√¨m ki·∫øm) |
| `GET` | `/stats` | Th·ªëng k√™ nh√¢n vi√™n |
| `POST` | `/` | T·∫°o nh√¢n vi√™n m·ªõi |
| `GET` | `/:id` | Xem chi ti·∫øt nh√¢n vi√™n |
| `PUT` | `/:id` | C·∫≠p nh·∫≠t nh√¢n vi√™n |
| `DELETE` | `/:id` | X√≥a nh√¢n vi√™n |
| `POST` | `/assign-order` | Ph√¢n c√¥ng ƒë∆°n h√†ng cho nh√¢n vi√™n |
| `POST` | `/:id/upload-avatar` | Upload avatar nh√¢n vi√™n |

---

### 3Ô∏è‚É£ D·ªäCH V·ª§ (SERVICES)
**Base URL**: `/api/services`

#### üì± Public Endpoints (Cached 5 ph√∫t)
| Method | Endpoint | M√¥ T·∫£ |
|--------|----------|-------|
| `GET` | `/` | L·∫•y t·∫•t c·∫£ d·ªãch v·ª• |
| `GET` | `/:id` | Xem chi ti·∫øt d·ªãch v·ª• |

#### üë®‚Äçüíº Admin Endpoints
| Method | Endpoint | M√¥ T·∫£ |
|--------|----------|-------|
| `GET` | `/admin/stats` | Th·ªëng k√™ d·ªãch v·ª• |
| `POST` | `/admin` | T·∫°o d·ªãch v·ª• m·ªõi |
| `PUT` | `/admin/:id` | C·∫≠p nh·∫≠t d·ªãch v·ª• |
| `DELETE` | `/admin/:id` | X√≥a d·ªãch v·ª• |
| `POST` | `/admin/:id/upload-image` | Upload ·∫£nh d·ªãch v·ª• |

---

### 4Ô∏è‚É£ S·∫¢N PH·∫®M (PRODUCTS)
**Base URL**: `/api/products`

#### üì± Public Endpoints (Cached 5 ph√∫t)
| Method | Endpoint | M√¥ T·∫£ |
|--------|----------|-------|
| `GET` | `/` | L·∫•y t·∫•t c·∫£ s·∫£n ph·∫©m |
| `GET` | `/:id` | Xem chi ti·∫øt s·∫£n ph·∫©m |
| `GET` | `/:productId/images` | L·∫•y danh s√°ch ·∫£nh s·∫£n ph·∫©m |

#### üë®‚Äçüíº Admin Endpoints
| Method | Endpoint | M√¥ T·∫£ |
|--------|----------|-------|
| `GET` | `/admin/stats` | Th·ªëng k√™ s·∫£n ph·∫©m |
| `POST` | `/admin` | T·∫°o s·∫£n ph·∫©m m·ªõi |
| `PUT` | `/admin/:id` | C·∫≠p nh·∫≠t s·∫£n ph·∫©m |
| `DELETE` | `/admin/:id` | X√≥a s·∫£n ph·∫©m |

#### üñºÔ∏è Product Images Management
| Method | Endpoint | M√¥ T·∫£ |
|--------|----------|-------|
| `POST` | `/images` | Th√™m ·∫£nh s·∫£n ph·∫©m |
| `PUT` | `/images/:id` | C·∫≠p nh·∫≠t ·∫£nh s·∫£n ph·∫©m |
| `DELETE` | `/images/:id` | X√≥a ·∫£nh s·∫£n ph·∫©m |

---

### 5Ô∏è‚É£ DANH M·ª§C (CATEGORIES)
**Base URL**: `/api/categories`

#### üì± Public Endpoints
| Method | Endpoint | M√¥ T·∫£ | Cache |
|--------|----------|-------|-------|
| `GET` | `/` | L·∫•y t·∫•t c·∫£ danh m·ª•c | 10 ph√∫t |
| `GET` | `/:id` | Xem chi ti·∫øt danh m·ª•c (k√®m s·∫£n ph·∫©m) | 5 ph√∫t |

#### üë®‚Äçüíº Admin Endpoints
| Method | Endpoint | M√¥ T·∫£ |
|--------|----------|-------|
| `GET` | `/admin/stats` | Th·ªëng k√™ danh m·ª•c |
| `POST` | `/admin` | T·∫°o danh m·ª•c m·ªõi |
| `PUT` | `/admin/:id` | C·∫≠p nh·∫≠t danh m·ª•c |
| `DELETE` | `/admin/:id` | X√≥a danh m·ª•c |
| `POST` | `/admin/:id/upload-image` | Upload ·∫£nh danh m·ª•c |

---

### 6Ô∏è‚É£ ƒê·ªûN D·ªäCH V·ª§ (SERVICE ORDERS)
**Base URL**: `/api/service-orders`

#### üì± Public Endpoints
| Method | Endpoint | M√¥ T·∫£ |
|--------|----------|-------|
| `GET` | `/:id` | Xem chi ti·∫øt ƒë∆°n d·ªãch v·ª• |
| `POST` | `/` | T·∫°o ƒë∆°n d·ªãch v·ª• m·ªõi |

#### üë®‚Äçüíº Admin Endpoints
| Method | Endpoint | M√¥ T·∫£ |
|--------|----------|-------|
| `GET` | `/` | L·∫•y t·∫•t c·∫£ ƒë∆°n (c√≥ filter & ph√¢n trang) |
| `GET` | `/admin/stats` | Th·ªëng k√™ ƒë∆°n d·ªãch v·ª• |
| `PUT` | `/admin/:id/status` | C·∫≠p nh·∫≠t tr·∫°ng th√°i ƒë∆°n |
| `PATCH` | `/admin/:id/complete` | Ho√†n th√†nh ƒë∆°n (t·∫°o b·∫£o h√†nh) |
| `PATCH` | `/admin/:id/assign` | Ph√¢n c√¥ng nh√¢n vi√™n |
| `DELETE` | `/admin/:id` | X√≥a ƒë∆°n d·ªãch v·ª• |

---

### 7Ô∏è‚É£ ·∫¢NH ƒê∆†N D·ªäCH V·ª§ (SERVICE ORDER IMAGES)
**Base URL**: `/api/service-order-images`

#### üì± Public Endpoints
| Method | Endpoint | M√¥ T·∫£ |
|--------|----------|-------|
| `GET` | `/:order_id` | L·∫•y t·∫•t c·∫£ ·∫£nh c·ªßa ƒë∆°n d·ªãch v·ª• |
| `POST` | `/` | Th√™m ·∫£nh m·ªõi cho ƒë∆°n d·ªãch v·ª• |
| `PUT` | `/:id` | C·∫≠p nh·∫≠t th√¥ng tin ·∫£nh |
| `DELETE` | `/:id` | X√≥a ·∫£nh |

**Note**: ·∫¢nh ƒë∆∞·ª£c ph√¢n lo·∫°i theo tr·∫°ng th√°i: `received`, `in_progress`, `completed`

---

### 8Ô∏è‚É£ PH∆Ø∆†NG TI·ªÜN (VEHICLES)
**Base URL**: `/api/vehicles`

#### üì± Public Endpoints
| Method | Endpoint | M√¥ T·∫£ |
|--------|----------|-------|
| `GET` | `/` | L·∫•y xe c·ªßa kh√°ch h√†ng |
| `GET` | `/search` | T√¨m ki·∫øm theo bi·ªÉn s·ªë |
| `GET` | `/:id` | Chi ti·∫øt ph∆∞∆°ng ti·ªán |
| `POST` | `/` | T·∫°o ph∆∞∆°ng ti·ªán m·ªõi |

#### üë®‚Äçüíº Admin Endpoints
| Method | Endpoint | M√¥ T·∫£ |
|--------|----------|-------|
| `GET` | `/admin/all` | L·∫•y t·∫•t c·∫£ xe (c√≥ ph√¢n trang & filter) |
| `GET` | `/admin/stats` | Th·ªëng k√™ ph∆∞∆°ng ti·ªán |
| `PUT` | `/admin/:id` | C·∫≠p nh·∫≠t ph∆∞∆°ng ti·ªán |
| `DELETE` | `/admin/:id` | X√≥a ph∆∞∆°ng ti·ªán |
| `POST` | `/admin/:id/upload-image` | Upload ·∫£nh xe |

---

### 9Ô∏è‚É£ ∆ØU ƒê√ÉI (OFFERS)
**Base URL**: `/api/offers`

#### üì± Public Endpoints
| Method | Endpoint | M√¥ T·∫£ |
|--------|----------|-------|
| `GET` | `/` | L·∫•y t·∫•t c·∫£ ∆∞u ƒë√£i |
| `GET` | `/:id` | Chi ti·∫øt ∆∞u ƒë√£i |

#### üë®‚Äçüíº Admin Endpoints
| Method | Endpoint | M√¥ T·∫£ |
|--------|----------|-------|
| `GET` | `/admin/stats` | Th·ªëng k√™ ∆∞u ƒë√£i |
| `POST` | `/admin` | T·∫°o ∆∞u ƒë√£i m·ªõi |
| `PUT` | `/admin/:id` | C·∫≠p nh·∫≠t ∆∞u ƒë√£i |
| `DELETE` | `/admin/:id` | X√≥a ∆∞u ƒë√£i |
| `POST` | `/admin/:id/upload-image` | Upload ·∫£nh ∆∞u ƒë√£i |

---

### üîü B·∫¢O H√ÄNH (WARRANTIES)
**Base URL**: `/api/warranties`

#### üì± Public Endpoints
| Method | Endpoint | M√¥ T·∫£ |
|--------|----------|-------|
| `GET` | `/:id` | Xem chi ti·∫øt b·∫£o h√†nh |

#### üë®‚Äçüíº Admin Endpoints
| Method | Endpoint | M√¥ T·∫£ |
|--------|----------|-------|
| `GET` | `/` | L·∫•y t·∫•t c·∫£ b·∫£o h√†nh |
| `GET` | `/admin/stats` | Th·ªëng k√™ b·∫£o h√†nh |
| `POST` | `/admin` | T·∫°o b·∫£o h√†nh m·ªõi |
| `PUT` | `/admin/:id` | C·∫≠p nh·∫≠t b·∫£o h√†nh |
| `DELETE` | `/admin/:id` | X√≥a b·∫£o h√†nh |

---

### 1Ô∏è‚É£1Ô∏è‚É£ TH√îNG B√ÅO (NOTIFICATIONS)
**Base URL**: `/api/notifications`

#### üì± User Endpoints
| Method | Endpoint | M√¥ T·∫£ |
|--------|----------|-------|
| `GET` | `/` | L·∫•y th√¥ng b√°o c·ªßa user |
| `GET` | `/unread-count` | ƒê·∫øm s·ªë th√¥ng b√°o ch∆∞a ƒë·ªçc |
| `PUT` | `/:id/read` | ƒê√°nh d·∫•u ƒë√£ ƒë·ªçc |
| `PUT` | `/read-all` | ƒê√°nh d·∫•u t·∫•t c·∫£ ƒë√£ ƒë·ªçc |
| `DELETE` | `/:id` | X√≥a th√¥ng b√°o |

#### üë®‚Äçüíº Admin Endpoints
| Method | Endpoint | M√¥ T·∫£ |
|--------|----------|-------|
| `GET` | `/admin/all` | L·∫•y t·∫•t c·∫£ th√¥ng b√°o (c√≥ ph√¢n trang & filter) |
| `GET` | `/admin/stats` | Th·ªëng k√™ th√¥ng b√°o |
| `POST` | `/send` | G·ª≠i th√¥ng b√°o t√πy ch·ªânh |

---

### 1Ô∏è‚É£2Ô∏è‚É£ FCM TOKEN (Push Notification Tokens)
**Base URL**: `/api/fcm-tokens`

#### üì± User Endpoints
| Method | Endpoint | M√¥ T·∫£ |
|--------|----------|-------|
| `POST` | `/register` | ƒêƒÉng k√Ω/c·∫≠p nh·∫≠t FCM token |
| `POST` | `/refresh` | L√†m m·ªõi token |
| `GET` | `/user` | L·∫•y token c·ªßa user |
| `DELETE` | `/` | X√≥a token (logout) |

#### üë®‚Äçüíº Admin & System Endpoints
| Method | Endpoint | M√¥ T·∫£ |
|--------|----------|-------|
| `GET` | `/active` | L·∫•y t·∫•t c·∫£ token ƒëang ho·∫°t ƒë·ªông |
| `GET` | `/stats` | Th·ªëng k√™ token |
| `POST` | `/deactivate-inactive` | V√¥ hi·ªáu h√≥a token kh√¥ng ho·∫°t ƒë·ªông (>10 ph√∫t) |
| `DELETE` | `/cleanup` | D·ªçn d·∫πp token c≈© (>30 ng√†y) |

---

### 1Ô∏è‚É£3Ô∏è‚É£ PUSH NOTIFICATIONS
**Base URL**: `/api/push-notifications`

#### üë®‚Äçüíº Admin Endpoints
| Method | Endpoint | M√¥ T·∫£ |
|--------|----------|-------|
| `POST` | `/send-to-user` | G·ª≠i th√¥ng b√°o cho 1 user c·ª• th·ªÉ |
| `POST` | `/send-to-all` | G·ª≠i th√¥ng b√°o cho t·∫•t c·∫£ user theo lo·∫°i |
| `POST` | `/send-to-topic` | G·ª≠i th√¥ng b√°o theo topic |
| `POST` | `/test` | Test th√¥ng b√°o |
| `GET` | `/health` | Ki·ªÉm tra tr·∫°ng th√°i Firebase |
| `GET` | `/stats` | Th·ªëng k√™ push notification |

---

### 1Ô∏è‚É£4Ô∏è‚É£ UPLOAD (File Upload)
**Base URL**: `/api/upload`

#### üì± Public Endpoints
| Method | Endpoint | M√¥ T·∫£ |
|--------|----------|-------|
| `POST` | `/single` | Upload 1 ·∫£nh |
| `POST` | `/multiple` | Upload nhi·ªÅu ·∫£nh (t·ªëi ƒëa 10) |
| `DELETE` | `/:filename` | X√≥a file ƒë√£ upload |

**Note**: File upload s·ª≠ d·ª•ng `multipart/form-data`:
- Single upload: field name = `image`
- Multiple upload: field name = `images`

**Static Files**: Truy c·∫≠p file ƒë√£ upload t·∫°i `/uploads/:filename`

---

## üîß T√çNH NƒÇNG K·ª∏ THU·∫¨T

### 1. Caching
- **Danh m·ª•c**: Cache 10 ph√∫t
- **S·∫£n ph·∫©m & D·ªãch v·ª•**: Cache 5 ph√∫t
- S·ª≠ d·ª•ng in-memory cache

### 2. Rate Limiting
- **Gi·ªõi h·∫°n**: 1000 requests / 15 ph√∫t
- √Åp d·ª•ng cho t·∫•t c·∫£ `/api/*` endpoints

### 3. Validation
- Middleware validation cho ƒëƒÉng k√Ω kh√°ch h√†ng
- Ki·ªÉm tra d·ªØ li·ªáu ƒë·∫ßu v√†o

### 4. Error Handling
- X·ª≠ l√Ω l·ªói t·∫≠p trung
- Response format chu·∫©n:
```json
{
  "success": false,
  "error": "Error message",
  "details": "Detailed information"
}
```

### 5. Compression
- T·ª± ƒë·ªông n√©n response ƒë·ªÉ t·ªëi ∆∞u bƒÉng th√¥ng

### 6. Background Jobs
- **Token Cleanup**: T·ª± ƒë·ªông d·ªçn d·∫πp FCM token c≈©
- **Token Refresh**: L√†m m·ªõi token ƒë·ªãnh k·ª≥
- S·ª≠ d·ª•ng `node-cron`

---

## üìä STATUS CODES

| Code | √ù Nghƒ©a |
|------|---------|
| `200` | Th√†nh c√¥ng |
| `201` | T·∫°o m·ªõi th√†nh c√¥ng |
| `400` | L·ªói d·ªØ li·ªáu ƒë·∫ßu v√†o |
| `404` | Kh√¥ng t√¨m th·∫•y |
| `429` | Qu√° nhi·ªÅu request (rate limit) |
| `500` | L·ªói server |
| `503` | Service kh√¥ng kh·∫£ d·ª•ng |

---

## üîê AUTHENTICATION

Hi·ªán t·∫°i h·ªá th·ªëng s·ª≠ d·ª•ng **phone-based authentication**:
- Kh√°ch h√†ng: ƒêƒÉng nh·∫≠p b·∫±ng s·ªë ƒëi·ªán tho·∫°i
- Nh√¢n vi√™n: ƒêƒÉng nh·∫≠p b·∫±ng employee ID v√† password/phone

**Note**: C√≥ th·ªÉ b·ªï sung JWT authentication trong t∆∞∆°ng lai cho b·∫£o m·∫≠t cao h∆°n.

---

## üì± PUSH NOTIFICATION FLOW

1. **Client ƒëƒÉng k√Ω**: G·ªçi `/api/fcm-tokens/register` v·ªõi FCM token
2. **Server l∆∞u token**: L∆∞u v√†o database v·ªõi user_id & user_type
3. **G·ª≠i th√¥ng b√°o**: 
   - Backend t·ª± ƒë·ªông g·ª≠i khi c√≥ s·ª± ki·ªán (ƒë∆°n h√†ng m·ªõi, c·∫≠p nh·∫≠t...)
   - Admin c√≥ th·ªÉ g·ª≠i th·ªß c√¥ng qua `/api/push-notifications/send-*`
4. **Client nh·∫≠n**: Hi·ªÉn th·ªã th√¥ng b√°o tr√™n app
5. **Tracking**: L∆∞u l·ªãch s·ª≠ th√¥ng b√°o v√†o database

---

## üóÑÔ∏è DATABASE

- **Type**: MySQL
- **Connection Pool**: S·ª≠ d·ª•ng mysql2 v·ªõi connection pool
- **Tables ch√≠nh**:
  - customers
  - employees
  - services
  - products
  - categories
  - service_orders
  - vehicles
  - warranties
  - notifications
  - fcm_tokens
  - offers

**File SQL**: `tnauto.sql` (import ƒë·ªÉ t·∫°o database)

---

## üöÄ DEPLOYMENT

### Environment Variables
C·∫ßn thi·∫øt l·∫≠p c√°c bi·∫øn m√¥i tr∆∞·ªùng:
```env
# Database
DB_HOST=localhost
DB_USER=root
DB_PASSWORD=your_password
DB_NAME=tnauto

# Server
PORT=3000
NODE_ENV=production

# Firebase (cho push notification)
FIREBASE_PROJECT_ID=your_project_id
# ... other Firebase configs
```

### Start Server
```bash
# Development
npm run dev

# Production
npm start
```

---

## üìû SUPPORT

- **Health Check**: `GET /health` - Ki·ªÉm tra tr·∫°ng th√°i server v√† database
- **API Docs**: `/api-docs` - Swagger UI documentation

---

## üìù NOTES

1. **Ph√¢n quy·ªÅn**: Hi·ªán t·∫°i ch∆∞a c√≥ middleware ki·ªÉm tra admin role, c·∫ßn b·ªï sung
2. **Pagination**: H·∫ßu h·∫øt list API ƒë·ªÅu h·ªó tr·ª£ ph√¢n trang (page, limit)
3. **Search**: Admin endpoints h·ªó tr·ª£ t√¨m ki·∫øm (search query param)
4. **Filters**: Service orders, vehicles h·ªó tr·ª£ l·ªçc theo nhi·ªÅu ti√™u ch√≠
5. **Image Upload**: L∆∞u local trong folder `uploads/`, c√≥ th·ªÉ n√¢ng c·∫•p l√™n Cloudinary

---

**Version**: 1.0.0  
**Last Updated**: October 2025  
**Maintained by**: TNAUTO Development Team

